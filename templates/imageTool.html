<!DOCTYPE html>
<html lang="ar" dir="rtl" data-bs-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>الجدول الدراسي</title>
    <link rel="stylesheet" href="/static/CSS/bootstrap.min.css">
    <link rel="stylesheet" href="/static/CSS/style.css" />
    <script type="module" src="/static/JS/main.js"></script>
    <style>
      #image_file {
        display: none;
      }
      .box__icon {
        height: 80px;
        fill: #8ab3bd;
        display: block;
      }
      .loader {
        width: 48px;
        height: 48px;
        border: 5px solid #fff;
        border-bottom-color: #1e7b93;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }

      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="min-vh-100 d-flex flex-column cairo-regular">
    <nav
      class="navbar navbar-expand-lg bg-body-tertiary py-1"
      style="background-image: linear-gradient(to right, #1e7b93, #add5db)"
    >
      <div class="container-fluid flex-row-reverse">
        <div class="d-flex">
          <div class="d-flex justify-content-center align-items-center">
            <button
              class="btn d-flex justify-content-center align-items-center btn-mode"
              style="height: 31px; width: 43px"
            >
              <svg
                class="icon w-100 h-100"
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-sun-fill"
                viewBox="0 0 16 16"
              >
                <path
                  d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"
                />
              </svg>
            </button>
            <button
              class="btn d-flex justify-content-center align-items-center"
              style="height: 31px; color: #fff"
            >
              AR
            </button>
          </div>
        </div>
        <a class="navbar-brand p-0 m-0 order-lg-1" 
          ><img
            src="/static/images/logo.png"
            alt="logo"
            width="100"
            height="55"
        /></a>
      </div>
    </nav>

    <div class="modal fade" style="top: 16%;" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="background-color: var(--bs-card1-bg);">
          <div class="w-100 h-100 d-flex justify-content-center align-items-center pt-5 px-3 pb-3">
            <div class="" style="width: 5rem; height: 5rem; color: #c41616;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle w-100 h-100 d-block" viewBox="0 0 16 16">
                <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
                <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
              </svg>
            </div>
          </div>
          <div class="modal-header border-0 pt-2 pb-0 d-block">
            <h5 class="modal-title text-center fw-bold">هل أنت متأكد من تعديل جدولك الحالي؟</h5>
          </div>
          <div class="modal-body px-0">
            <p class="text-center px-5">سيتم حذف جدولك الحالي ولن تتمكن من الرجوع إلى الجدول السابق</p>
          </div>
          <div class="modal-footer border-0 pt-0 pb-5 justify-content-center">
            <button type="button" onclick="deleteStudentScheduleFromDB(this)" class="btn btn-danger px-4" style="background-color: #c41616">موافق</button>
            <a class="btn px-4" href="{{ url_for('home') }}" style="background-color: #d9d9d9; color: #000;">إلغاء</a>
          </div>
        </div>
      </div>
    </div>

    <div id="alert_div" class="m-0"></div>

    <div
      class="container w-100 py-5 mt-4 d-flex flex-column justify-content-center align-items-center flex-grow-1"
      style="min-height: 70vh"
    >
      {% if message %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show"
        id="alert_div"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% if url %}
      <script>
        if ("{{ category }}" === "success") {
          setTimeout(() => {
            window.location.href = "{{ url }}";
          }, 500);
        }
      </script>  
      {% endif %}    
      {% endif %}

      {% if not df %}
      <div
        class="card border-2 p-2 m-2 bg-transparent rounded-0"
        style="border-style: dashed; min-width: 70%; height: 18rem"
      >
        <div
          class="card-body d-flex flex-column justify-content-center align-items-center"
        >
          <svg
            class="box__icon w-100 mb-5"
            xmlns="http://www.w3.org/2000/svg"
            width="50"
            height="43"
            viewBox="0 0 50 43"
          >
            <path
              d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z"
            ></path>
          </svg>
          <form
            class="w-100 d-flex flex-column justify-content-center align-items-center text-center"
            id="uploadForm"
            action="/upload"
            method="post"
            enctype="multipart/form-data"
          >
            <label for="image_file" style="color: #278a9f"
              ><strong class="mx-1">اضغط هنا</strong
              ><span class="mx-1">لاختيار ملف الصورة</span></label
            >
            <input
              type="file"
              name="image"
              id="image_file"
              accept="image/*"
              required
            />
            <!-- <button type="submit" class="btn btn-primary px-5 mt-5">رفع</button> -->
          </form>
        </div>
      </div>
      <div class="text-center text-secondary my-3 warring" style="font-size: 14px">
        <p class="mb-0 text-wrap">
          <strong>ملاحظة :</strong> قم بإدخال جدولك الدراسي للترم الحالي بصيغة
          jpeg, jpg, png .
        </p>
      </div>
      {% endif %}

      <div id="loadingSpinner" class="d-none"><span class="loader"></span></div>

      {% if df %}
      <div
        class="w-100 d-flex flex-column justify-content-center align-items-center pb-5"
        id="responseDiv"
      >
        <div class="w-100 h-100 my-3" style="overflow-x: auto">
          <div class="table-responsive rounded" id="output">{{ df | safe }}</div>
        </div>
        <div
          class="mt-3 mb-4 w-100 d-flex justify-content-center align-items-center"
        >
          <form action="/save" method="post" enctype="multipart/form-data">
            <button
              type="submit"
              class="btn px-5 text-light"
              style="background-color: #278a9f"
            >
              حفظ
            </button>
          </form>
        </div>
      </div>
      {% endif %}

    </div>

    <footer class="w-100 mt-5 navbar justify-content-center align-items-center">
      <p class="m-0 text-center fw-semibold" style="font-size: 15px">
        &copy; جميع الحقوق محفوظة - 2025
      </p>
    </footer>

    <script src="/static/JS/bootstrap.bundle.min.js"></script>
    <script src="/static/JS/popper.min.js"></script>
  </body>
  
  <script>
    const imageInput = document.getElementById("image_file");
    const form = document.getElementById("uploadForm");
    const spinner = document.getElementById("loadingSpinner");
    const cardDiv = document.querySelector(".card");
    const warringDiv = document.querySelector(".warring")

    if (cardDiv && imageInput) {
      cardDiv.classList.add("d-flex");
      warringDiv.classList.add("d-block");
      spinner.classList.add("d-none");

      imageInput.addEventListener("change", () => {
        form.submit();
        cardDiv.classList.remove("d-flex");
        cardDiv.classList.add("d-none");
        warringDiv.classList.remove("d-block");
        warringDiv.classList.add("d-none");
        spinner.classList.remove("d-none");
        spinner.classList.add("d-block");
      });

    }

    const edit = "{{ edit }}"; // Flask template variable
    document.querySelector('.modal').style.display = 'none';

    if (edit === 'True') {
        document.querySelector('.modal').style.display = 'block';
    }

    function deleteStudentScheduleFromDB(btn){
      btn.disabled = false;

      fetch('/delete_student_schedule', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({}) // Send any data you need here
      })
      .then(response => response.json())
      .then(data => {
        const alertDiv = document.getElementById("alert_div");
            if (data.alert) {
              data.alert.forEach(([category, message]) => {
                alertDiv.innerHTML += `
                <div class="alert alert-${category} alert-dismissible fade show m-0" role="alert">
                  ${message}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                `;
              });
            }

            if (data.alert.some(([category]) => category === 'success')) {
                document.querySelector('.modal').style.display = 'none';
            } 

            if (data.alert.some(([category]) => category === 'danger')) {
              btn.disabled = true;
            } 

            setTimeout(() => {
              const alertDiv = document.querySelector('#alert_div .alert');
              if (alertDiv) {
                alertDiv.classList.remove('show'); // Hide the alert by removing 'show'
              }
            }, 4000);         
      });
    }

  </script>
</html>
